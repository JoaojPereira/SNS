// ============================================================================
// MEDIDAS - RECURSOS HUMANOS E PRODUTIVIDADE
// ============================================================================
// Modelo: Star Schema
// Tabelas: FactAtendimentosUrgencia, FactCustos, DimProfissionais
// Cobertura RH: 92.1% dos registos (4.271 de 4.636 linhas)
// ============================================================================


// ============================================================================
// 1. CONTAGENS B√ÅSICAS DE PROFISSIONAIS
// ============================================================================

Total Profissionais = 
    [Total M√©dicos] + [Total M√©dicos Internos] + [Total Enfermeiros]

Total M√©dicos = 
    SUM(FactAtendimentosUrgencia[M√©dicos])

Total M√©dicos Internos = 
    SUM(FactAtendimentosUrgencia[MedicosInternos])

Total Enfermeiros = 
    SUM(FactAtendimentosUrgencia[Enfermeiros])

Total M√©dicos Completo = 
    [Total M√©dicos] + [Total M√©dicos Internos]

Total T√©cnicos = 
    CALCULATE(
        SUM(DimProfissionais[N¬∫Profissionais]),
        DimIdPorf[Profissao] IN {"Tec. Sup. Sa√∫de", "Tec. Sup. Diag. terap√™utica"}
    )


// ============================================================================
// 2. R√ÅCIOS DE PROFISSIONAIS
// ============================================================================

R√°cio Enfermeiro/M√©dico = 
    DIVIDE([Total Enfermeiros], [Total M√©dicos], 0)

R√°cio Enfermeiro/M√©dico Completo = 
    DIVIDE([Total Enfermeiros], [Total M√©dicos Completo], 0)

R√°cio M√©dicos por 1000 Atendimentos = 
    VAR _Medicos = [Total M√©dicos]
    VAR _Atendimentos = [Total Atendimentos]
    RETURN
        DIVIDE(_Medicos * 1000, _Atendimentos, 0)

R√°cio Enfermeiros por 1000 Atendimentos = 
    VAR _Enfermeiros = [Total Enfermeiros]
    VAR _Atendimentos = [Total Atendimentos]
    RETURN
        DIVIDE(_Enfermeiros * 1000, _Atendimentos, 0)


// ============================================================================
// 3. PRODUTIVIDADE (Atendimentos por Profissional)
// ============================================================================

Atendimentos por M√©dico = 
    DIVIDE([Total Atendimentos], [Total M√©dicos], 0)

Atendimentos por Enfermeiro = 
    DIVIDE([Total Atendimentos], [Total Enfermeiros], 0)

Atendimentos por Profissional = 
    DIVIDE([Total Atendimentos], [Total Profissionais], 0)

Atendimentos por M√©dico Completo = 
    DIVIDE([Total Atendimentos], [Total M√©dicos Completo], 0)


// ============================================================================
// 4. COMPARA√á√ÉO COM M√âDIA NACIONAL
// ============================================================================

R√°cio Enfermeiro/M√©dico - M√©dia Nacional = 
    VAR _RacioAtual = [R√°cio Enfermeiro/M√©dico]
    VAR _MediaNacional = 
        CALCULATE(
            [R√°cio Enfermeiro/M√©dico],
            ALL(DimInstituicao),
            ALL(DimRegiao)
        )
    RETURN
        _RacioAtual - _MediaNacional

Atendimentos por Profissional - M√©dia Nacional = 
    VAR _AtendAtual = [Atendimentos por Profissional]
    VAR _MediaNacional = 
        CALCULATE(
            [Atendimentos por Profissional],
            ALL(DimInstituicao),
            ALL(DimRegiao)
        )
    RETURN
        _AtendAtual - _MediaNacional

Produtividade vs Nacional (%) = 
    VAR _Atual = [Atendimentos por Profissional]
    VAR _Nacional = 
        CALCULATE(
            [Atendimentos por Profissional],
            ALL(DimInstituicao),
            ALL(DimRegiao)
        )
    RETURN
        DIVIDE(_Atual - _Nacional, _Nacional, 0)


// ============================================================================
// 5. AN√ÅLISE DE CUSTOS POR PROFISSIONAL
// ============================================================================

Custo por Profissional = 
    VAR _CustoTotal = SUM(FactCustos[Despesa])
    VAR _NumProfissionais = [Total Profissionais]
    RETURN
        DIVIDE(_CustoTotal, _NumProfissionais, BLANK())

Custo por M√©dico = 
    VAR _CustoTotal = SUM(FactCustos[Despesa])
    VAR _NumMedicos = [Total M√©dicos]
    RETURN
        DIVIDE(_CustoTotal, _NumMedicos, BLANK())

Custo por Enfermeiro = 
    VAR _CustoTotal = SUM(FactCustos[Despesa])
    VAR _NumEnfermeiros = [Total Enfermeiros]
    RETURN
        DIVIDE(_CustoTotal, _NumEnfermeiros, BLANK())

Custo por Profissional - M√©dia Nacional = 
    VAR _CustoAtual = [Custo por Profissional]
    VAR _MediaNacional = 
        CALCULATE(
            [Custo por Profissional],
            ALL(DimInstituicao),
            ALL(DimRegiao)
        )
    RETURN
        _CustoAtual - _MediaNacional


// ============================================================================
// 6. INDICADORES DE EFICI√äNCIA
// ============================================================================

Score Efici√™ncia RH = 
    VAR _AtendPorProf = [Atendimentos por Profissional]
    VAR _MediaAtendPorProf = 
        CALCULATE(
            [Atendimentos por Profissional],
            ALL(DimInstituicao)
        )
    VAR _RacioAtual = [R√°cio Enfermeiro/M√©dico]
    VAR _RacioIdeal = 2.0
    VAR _ScoreProdutividade = DIVIDE(_AtendPorProf, _MediaAtendPorProf, 1) * 60
    VAR _ScoreRacio = MIN(DIVIDE(_RacioAtual, _RacioIdeal, 0), 1) * 40
    RETURN
        _ScoreProdutividade + _ScoreRacio

Score Produtividade = 
    VAR _Atual = [Atendimentos por Profissional]
    VAR _Media = 
        CALCULATE(
            [Atendimentos por Profissional],
            ALL(DimInstituicao)
        )
    RETURN
        DIVIDE(_Atual, _Media, 0) * 100


// ============================================================================
// 7. INDICADORES DE ALERTA
// ============================================================================

Status R√°cio Enfermeiro/M√©dico = 
    VAR _Racio = [R√°cio Enfermeiro/M√©dico]
    RETURN
        SWITCH(
            TRUE(),
            _Racio >= 2.0, "‚úÖ ADEQUADO",
            _Racio >= 1.5, "‚ö†Ô∏è ATEN√á√ÉO",
            _Racio >= 1.0, "üî∂ D√âFICE",
            "üî¥ CR√çTICO"
        )

Status Produtividade = 
    VAR _Score = [Score Produtividade]
    RETURN
        SWITCH(
            TRUE(),
            _Score >= 120, "‚≠ê EXCELENTE",
            _Score >= 100, "‚úÖ ADEQUADA",
            _Score >= 80, "‚ö†Ô∏è ABAIXO M√âDIA",
            "üî¥ CR√çTICA"
        )

Alerta RH = 
    VAR _Racio = [R√°cio Enfermeiro/M√©dico]
    VAR _Produtividade = [Score Produtividade]
    RETURN
        SWITCH(
            TRUE(),
            _Racio < 1.5 && _Produtividade < 80, "üî¥ D√âFICE CR√çTICO RH",
            _Racio < 1.5, "üî∂ D√âFICE ENFERMEIROS",
            _Produtividade < 80, "‚ö†Ô∏è PRODUTIVIDADE BAIXA",
            "‚úÖ Sem Alertas"
        )

‚ö† R√°cio Enfermeiro/M√©dico Abaixo de 2 = 
    IF([R√°cio Enfermeiro/M√©dico] < 2, "‚ö†Ô∏è R√°cio baixo", "‚úÖ OK")

‚ö† Produtividade Baixa = 
    VAR _AtendPorProf = [Atendimentos por Profissional]
    VAR _MediaNacional = 
        CALCULATE(
            [Atendimentos por Profissional],
            ALL(DimInstituicao)
        )
    RETURN
        IF(_AtendPorProf < _MediaNacional * 0.8, "‚ö†Ô∏è Produtividade < 80% m√©dia", "‚úÖ OK")

‚ö† Custo por Profissional Elevado = 
    VAR _CustoPorProf = [Custo por Profissional]
    VAR _MediaNacional = 
        CALCULATE(
            [Custo por Profissional],
            ALL(DimInstituicao)
        )
    RETURN
        IF(_CustoPorProf > _MediaNacional * 1.2, "‚ö†Ô∏è Custo > 120% m√©dia", "‚úÖ OK")


// ============================================================================
// 8. EVOLU√á√ÉO TEMPORAL (Year over Year)
// ============================================================================

Total Profissionais Ano Anterior = 
    CALCULATE(
        [Total Profissionais],
        SAMEPERIODLASTYEAR(DimCalendar[Data])
    )

Varia√ß√£o YoY Profissionais = 
    [Total Profissionais] - [Total Profissionais Ano Anterior]

% Varia√ß√£o YoY Profissionais = 
    DIVIDE(
        [Varia√ß√£o YoY Profissionais],
        [Total Profissionais Ano Anterior],
        0
    )

Varia√ß√£o YoY M√©dicos = 
    VAR _Atual = [Total M√©dicos]
    VAR _Anterior = 
        CALCULATE(
            [Total M√©dicos],
            SAMEPERIODLASTYEAR(DimCalendar[Data])
        )
    RETURN
        DIVIDE(_Atual - _Anterior, _Anterior, 0)

Varia√ß√£o YoY Enfermeiros = 
    VAR _Atual = [Total Enfermeiros]
    VAR _Anterior = 
        CALCULATE(
            [Total Enfermeiros],
            SAMEPERIODLASTYEAR(DimCalendar[Data])
        )
    RETURN
        DIVIDE(_Atual - _Anterior, _Anterior, 0)

Varia√ß√£o % Custo por Profissional YoY = 
    VAR _AnoAtual = [Custo por Profissional]
    VAR _AnoAnterior = 
        CALCULATE(
            [Custo por Profissional],
            SAMEPERIODLASTYEAR(DimCalendar[Data])
        )
    RETURN
        DIVIDE(_AnoAtual - _AnoAnterior, _AnoAnterior, BLANK())


// ============================================================================
// 9. AN√ÅLISE DE COBERTURA DE DADOS
// ============================================================================

Tem Dados RH = 
    IF([Total Profissionais] > 0, "SIM", "N√ÉO")

% Registos com Dados RH = 
    VAR _TotalRegistos = COUNTROWS(FactAtendimentosUrgencia)
    VAR _RegistrosComRH = 
        CALCULATE(
            COUNTROWS(FactAtendimentosUrgencia),
            FactAtendimentosUrgencia[M√©dicos] > 0 || 
            FactAtendimentosUrgencia[Enfermeiros] > 0
        )
    RETURN
        DIVIDE(_RegistrosComRH, _TotalRegistos, 0)


// ============================================================================
// 10. CORRELA√á√ïES E AN√ÅLISES CRUZADAS
// ============================================================================

Correla√ß√£o RH vs Tempo Espera = 
    // Para usar em scatter plot: Atendimentos por Profissional (X) vs Tempo Espera (Y)
    // Correla√ß√£o negativa esperada: mais profissionais = menos tempo espera
    "Use em Scatter Plot: X = Atend/Prof | Y = Tempo Espera"

D√©fice Enfermeiros Estimado = 
    VAR _EnfermeirosAtuais = [Total Enfermeiros]
    VAR _MedicosAtuais = [Total M√©dicos]
    VAR _EnfermeirosNecessarios = _MedicosAtuais * 2  // R√°cio ideal = 2.0
    VAR _Deficit = _EnfermeirosNecessarios - _EnfermeirosAtuais
    RETURN
        IF(_Deficit > 0, _Deficit, 0)


// ============================================================================
// 11. RANKINGS E BENCHMARKING
// ============================================================================

Ranking Produtividade = 
    RANKX(
        ALL(DimInstituicao[InstituicaoNome]),
        [Atendimentos por Profissional],
        ,
        DESC,
        DENSE
    )

Ranking R√°cio Enfermeiro/M√©dico = 
    RANKX(
        ALL(DimInstituicao[InstituicaoNome]),
        [R√°cio Enfermeiro/M√©dico],
        ,
        DESC,
        DENSE
    )

Top 20% Produtividade = 
    IF(
        [Ranking Produtividade] <= COUNTROWS(ALL(DimInstituicao)) * 0.2,
        "SIM",
        "N√ÉO"
    )


// ============================================================================
// NOTAS DE UTILIZA√á√ÉO E DOCUMENTA√á√ÉO
// ============================================================================
//
// üìä COBERTURA DE DADOS:
//    ‚Ä¢ Dados RH dispon√≠veis: 92.1% dos registos (4.271 de 4.636 linhas)
//    ‚Ä¢ Use filtro [Tem Dados RH] = "SIM" para an√°lises precisas
//    ‚Ä¢ 7.9% registos sem dados RH (365 linhas)
//
// üèóÔ∏è ESTRUTURA DO MODELO:
//    ‚Ä¢ FactAtendimentosUrgencia: M√©dicos, MedicosInternos, Enfermeiros
//    ‚Ä¢ FactCustos: Despesa
//    ‚Ä¢ DimProfissionais: N¬∫Profissionais, Profissao
//    ‚Ä¢ Relacionamentos: TimeKey, RegiaoID, InstituicaoID
//
// üéØ R√ÅCIOS RECOMENDADOS:
//    ‚Ä¢ R√°cio Enfermeiro/M√©dico: Meta >= 2.0
//      - Verde (‚úÖ): >= 2.0
//      - Amarelo (‚ö†Ô∏è): 1.5-2.0
//      - Vermelho (üî¥): < 1.5
//    ‚Ä¢ Score Produtividade: Comparar com m√©dia nacional
//      - Excelente (‚≠ê): >= 120
//      - Adequada (‚úÖ): 100-120
//      - Abaixo (‚ö†Ô∏è): 80-100
//      - Cr√≠tica (üî¥): < 80
//
// üîó AN√ÅLISES CRUZADAS RECOMENDADAS:
//    1. RH + Atendimentos: Produtividade por tipo de urg√™ncia
//    2. RH + Custos: Efici√™ncia financeira (filtrar [Tem Dados Custo])
//    3. RH + Tempo Espera: Correla√ß√£o negativa esperada
//    4. RH + Qualidade: Impacto na satisfa√ß√£o do utente
//
// üìà VISUALIZA√á√ïES RECOMENDADAS:
//    1. Scatter Plot:
//       - X: Atendimentos por Profissional
//       - Y: Tempo Espera M√©dio
//       - Tamanho: Total Atendimentos
//       - Cor: Status R√°cio Enfermeiro/M√©dico
//
//    2. Gauge Chart:
//       - Valor: R√°cio Enfermeiro/M√©dico
//       - Zonas: Vermelho (0-1.5), Amarelo (1.5-2.0), Verde (>2.0)
//       - Target: 2.0
//
//    3. Line Chart:
//       - S√©ries: M√©dicos, M√©dicos Internos, Enfermeiros
//       - Eixo X: Data (mensal/trimestral)
//       - Mostrar varia√ß√£o YoY
//
//    4. Matrix:
//       - Linhas: Institui√ß√£o
//       - Colunas: R√°cios + Status + Alertas
//       - Valores: C√≥digos de cor condicionais
//
//    5. Bar Chart:
//       - Ranking Produtividade por Institui√ß√£o
//       - Linha de refer√™ncia: M√©dia Nacional
//       - Destacar Top 20%
//
//    6. Card/KPI:
//       - Alertas cr√≠ticos (üî¥)
//       - D√©fice enfermeiros estimado
//       - % Varia√ß√£o YoY
//
// ‚ö†Ô∏è ALERTAS AUTOM√ÅTICOS:
//    ‚Ä¢ üî¥ D√©fice Cr√≠tico RH: R√°cio < 1.5 AND Produtividade < 80%
//    ‚Ä¢ üî∂ D√©fice Enfermeiros: R√°cio < 1.5
//    ‚Ä¢ ‚ö†Ô∏è Produtividade Baixa: Score < 80
//    ‚Ä¢ ‚ö†Ô∏è Custo Elevado: > 120% da m√©dia nacional
//
// üö´ LIMITA√á√ïES CONHECIDAS:
//    ‚Ä¢ Dados agregados mensalmente (n√£o permite an√°lise di√°ria de turnos)
//    ‚Ä¢ N√£o distingue especialidades m√©dicas
//    ‚Ä¢ N√£o inclui dados de aus√™ncias/f√©rias/baixas
//    ‚Ä¢ Dados de custos podem ter granularidade diferente de RH
//
// üí° BOAS PR√ÅTICAS:
//    1. Sempre filtrar por [Tem Dados RH] = "SIM" em an√°lises detalhadas
//    2. Usar filtros temporais consistentes ao comparar custos vs RH
//    3. Agrupar por Regi√£o para an√°lises de benchmarking
//    4. Combinar m√∫ltiplas medidas para an√°lise hol√≠stica
//    5. Validar outliers antes de tirar conclus√µes
//
// üîÑ MANUTEN√á√ÉO:
//    ‚Ä¢ Atualizar [R√°cio Ideal] se guidelines nacionais mudarem
//    ‚Ä¢ Rever limites de alertas anualmente
//    ‚Ä¢ Adicionar novas profiss√µes em DimProfissionais conforme necess√°rio
//
// ============================================================================