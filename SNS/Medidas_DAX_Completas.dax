// ============================================================================
// MEDIDAS DAX - REPORT DE INEFICI√äNCIAS NAS URG√äNCIAS HOSPITALARES SNS
// ============================================================================
// Projeto: Dashboard SNS - An√°lise de Inefici√™ncias (2016-2025)
// Modelo: Star Schema (2 Factuais + 4 Dimens√µes)
// Tabelas: FactAtendimentosUrgencia (15 colunas), FactMonitorizacaoSazonal,
//          DimCalendar, DimRegiao, DimInstituicao, DimIndicador
// Dados: Triagem Manchester (2016-2025) - 100% cobertura
// Autor: Jo√£o Domingues Pereira
// Data: Dezembro 2025
// Vers√£o: 3.3 FINAL
// ============================================================================
// 
// ESTRUTURA FactAtendimentosUrgencia (18 colunas):
// - Colunas 1-4:   Chaves (Per√≠odo, TimeKey, RegiaoID, InstituicaoID)
// - Colunas 5-12:  Triagem Manchester (7 cores + TotalAtendimentos)
// - Colunas 13-15: Recursos Humanos (M√©dicos, MedicosInternos, Enfermeiros)
// 
// FOCO: An√°lise de FALSAS URG√äNCIAS e inefici√™ncias operacionais
// ============================================================================


// ============================================================================
// 1Ô∏è‚É£ M√âTRICAS B√ÅSICAS DE ATENDIMENTO
// ============================================================================

Total Atendimentos = 
SUM(FactAtendimentosUrgencia[TotalAtendimentos])

Atendimentos Vermelha = 
SUM(FactAtendimentosUrgencia[Atendimentos_Vermelha])

Atendimentos Laranja = 
SUM(FactAtendimentosUrgencia[Atendimentos_Laranja])

Atendimentos Amarela = 
SUM(FactAtendimentosUrgencia[Atendimentos_Amarela])

Atendimentos Verde = 
SUM(FactAtendimentosUrgencia[Atendimentos_Verde])

Atendimentos Azul = 
SUM(FactAtendimentosUrgencia[Atendimentos_Azul])

Atendimentos Branca = 
SUM(FactAtendimentosUrgencia[Atendimentos_Branca])

Atendimentos Sem Triagem = 
SUM(FactAtendimentosUrgencia[Atendimentos_SemTriagem])

// M√©dia Mensal
M√©dia Mensal Atendimentos = 
AVERAGEX(
    VALUES(DimCalendar[AnoMes]),
    [Total Atendimentos]
)

// M√©dia M√≥vel 3 Meses (SEM acumula√ß√£o anual - corrige reset no gr√°fico)
M√©dia M√≥vel 3 Meses = 
VAR DataAtual = LASTDATE(DimCalendar[Data])
VAR Inicio3Meses = DATEADD(STARTOFMONTH(DataAtual), -2, MONTH)
RETURN
    CALCULATE(
        AVERAGEX(
            VALUES(DimCalendar[AnoMes]),
            [Total Atendimentos]
        ),
        DATESBETWEEN(DimCalendar[Data], Inicio3Meses, DataAtual),
        ALL(DimCalendar[Ano])  -- Remove filtro de ano para evitar quebra
    )


// ============================================================================
// 2Ô∏è‚É£ IDENTIFICA√á√ÉO DE URG√äNCIAS FALSAS (INEFICI√äNCIA OPERACIONAL)
// ============================================================================

Atendimentos Urgentes = 
[Atendimentos Vermelha] + [Atendimentos Laranja]

Atendimentos N√£o Urgentes = 
[Atendimentos Verde] + [Atendimentos Azul] + [Atendimentos Branca]

% N√£o Urgentes = 
DIVIDE([Atendimentos N√£o Urgentes], [Total Atendimentos], 0)

% Verde/Azul = 
DIVIDE([Atendimentos Verde] + [Atendimentos Azul], [Total Atendimentos], 0)

// Sem√°foro de Inefici√™ncia
Status Urg√™ncias Falsas = 
SWITCH(
    TRUE(),
    [% N√£o Urgentes] < 0.25, "‚úÖ Eficiente (< 25%)",
    [% N√£o Urgentes] < 0.35, "‚ö†Ô∏è Aten√ß√£o (25-35%)",
    "‚ùå Cr√≠tico (> 35%)"
)

// Estimativa de Custo Desperdi√ßado
// Assumindo custo m√©dio 120‚Ç¨/atendimento urg√™ncia hospitalar
// vs 30‚Ç¨ em Centro de Sa√∫de
Custo Desperdi√ßado Estimado = 
[Atendimentos N√£o Urgentes] * 90


// ============================================================================
// 3Ô∏è‚É£ AN√ÅLISE DE CUSTOS E INEFICI√äNCIA FINANCEIRA
// ============================================================================


// NOVA L√ìGICA: Custo estimado por epis√≥dio de urg√™ncia
Custo Estimado por Epis√≥dio = 150

Despesa Total Estimada = 
[Total Atendimentos] * [Custo Estimado por Epis√≥dio]

Custo M√©dio por Doente = 
[Custo Estimado por Epis√≥dio]

Custo por Atendimento = 
[Custo Estimado por Epis√≥dio]

// Removidas medidas dependentes de dados reais de custos


// ============================================================================
// 4Ô∏è‚É£ INDICADORES DE RECURSOS HUMANOS
// ============================================================================

Total M√©dicos = 
SUM(FactAtendimentosUrgencia[M√©dicos])

Total M√©dicos Internos = 
SUM(FactAtendimentosUrgencia[MedicosInternos])

Total Enfermeiros = 
SUM(FactAtendimentosUrgencia[Enfermeiros])

Total Profissionais = 
[Total M√©dicos] + [Total M√©dicos Internos] + [Total Enfermeiros]

// R√°cios
R√°cio Enfermeiro/M√©dico = 
DIVIDE([Total Enfermeiros], [Total M√©dicos], 0)

// Status R√°cio (ideal: 2-3 enfermeiros por m√©dico)
Status R√°cio Enf/Med = 
VAR Racio = [R√°cio Enfermeiro/M√©dico]
RETURN
SWITCH(
    TRUE(),
    Racio < 1.5, "‚ùå D√©fice Enfermeiros",
    Racio < 2, "‚ö†Ô∏è Abaixo do Ideal",
    Racio <= 3, "‚úÖ Ideal",
    "‚ö†Ô∏è Excesso Enfermeiros"
)

// Produtividade
Atendimentos por M√©dico = 
DIVIDE([Total Atendimentos], [Total M√©dicos], 0)

Atendimentos por Enfermeiro = 
DIVIDE([Total Atendimentos], [Total Enfermeiros], 0)

Atendimentos por Profissional = 
DIVIDE([Total Atendimentos], [Total Profissionais], 0)

// Benchmark Produtividade
Produtividade M√©dia Nacional = 
CALCULATE(
    [Atendimentos por M√©dico],
    ALLEXCEPT(FactAtendimentosUrgencia, DimCalendar)
)

Desvio Produtividade = 
[Atendimentos por M√©dico] - [Produtividade M√©dia Nacional]

// Registros com dados de RH (92.1% cobertura)
Registros com RH = 
CALCULATE(
    COUNTROWS(FactAtendimentosUrgencia),
    FactAtendimentosUrgencia[M√©dicos] > 0
)


// ============================================================================
// 5Ô∏è‚É£ AN√ÅLISE DE TEMPO DE ESPERA (FactMonitorizacaoSazonal)
// ============================================================================

Tempo Espera M√©dio = 
CALCULATE(
    AVERAGE(FactMonitorizacaoSazonal[Valor]),
    DimIndicador[IndicadorNome] = "Tempo M√©dio Espera Triagem-Observa√ß√£o"
)

Taxa Verde/Azul M√©dia = 
CALCULATE(
    AVERAGE(FactMonitorizacaoSazonal[Valor]),
    DimIndicador[IndicadorNome] = "Taxa Atendimentos Verde/Azul"
)

Taxa Internamento M√©dia = 
CALCULATE(
    AVERAGE(FactMonitorizacaoSazonal[Valor]),
    DimIndicador[IndicadorNome] = "Taxa Atendimentos c/ Internamento"
)

Total Epis√≥dios = 
CALCULATE(
    SUM(FactMonitorizacaoSazonal[Valor]),
    DimIndicador[IndicadorNome] = "N¬∫ Epis√≥dios Urg√™ncia"
)

// Meta Manchester: Triagem Amarela = 60 minutos
% Acima Meta 60min = 
VAR TotalLinhas = 
    CALCULATE(
        COUNTROWS(FactMonitorizacaoSazonal),
        DimIndicador[IndicadorNome] = "Tempo M√©dio Espera Triagem-Observa√ß√£o"
    )
VAR LinhasAcima60 = 
    CALCULATE(
        COUNTROWS(FactMonitorizacaoSazonal),
        FactMonitorizacaoSazonal[Valor] > 60,
        DimIndicador[IndicadorNome] = "Tempo M√©dio Espera Triagem-Observa√ß√£o"
    )
RETURN
    DIVIDE(LinhasAcima60, TotalLinhas, 0)

// Status Tempo de Espera
Status Tempo Espera = 
VAR Tempo = [Tempo Espera M√©dio]
RETURN
SWITCH(
    TRUE(),
    Tempo <= 60, "‚úÖ Dentro da Meta",
    Tempo <= 90, "‚ö†Ô∏è Ligeiramente Acima",
    "‚ùå Cr√≠tico (> 90min)"
)


// ============================================================================
// 6Ô∏è‚É£ AN√ÅLISE TEMPORAL E TEND√äNCIAS
// ============================================================================

// Varia√ß√£o Year-over-Year
Varia√ß√£o YoY Atendimentos = 
VAR AnoAtual = [Total Atendimentos]
VAR AnoAnterior = 
    CALCULATE(
        [Total Atendimentos],
        DATEADD(DimCalendar[Data], -1, YEAR)
    )
RETURN
    DIVIDE(AnoAtual - AnoAnterior, AnoAnterior, 0)

Varia√ß√£o YoY % N√£o Urgentes = 
VAR Atual = [% N√£o Urgentes]
VAR Anterior = 
    CALCULATE(
        [% N√£o Urgentes],
        DATEADD(DimCalendar[Data], -1, YEAR)
    )
RETURN
    Atual - Anterior

// M√™s a M√™s
Varia√ß√£o MoM Atendimentos = 
VAR MesAtual = [Total Atendimentos]
VAR MesAnterior = 
    CALCULATE(
        [Total Atendimentos],
        DATEADD(DimCalendar[Data], -1, MONTH)
    )
RETURN
    DIVIDE(MesAtual - MesAnterior, MesAnterior, 0)

// Tend√™ncia (para visual de linha)
Linha Tend√™ncia N√£o Urgentes = 
// Usar em gr√°fico de linha para ver evolu√ß√£o temporal
[% N√£o Urgentes]


// ============================================================================
// 7Ô∏è‚É£ RANKINGS E BENCHMARKING
// ============================================================================

// Ranking % N√£o Urgentes (1 = pior)
Ranking N√£o Urgentes = 
RANKX(
    ALL(DimInstituicao[InstituicaoNome]),
    [% N√£o Urgentes],
    ,
    DESC,
    DENSE
)

// Ranking Custo (1 = mais caro)
Ranking Custo = 
RANKX(
    FILTER(
        ALL(DimInstituicao[InstituicaoNome]),
        [Registros com Custos] > 0
    ),
    [Custo M√©dio por Doente],
    ,
    DESC,
    DENSE
)

// Ranking Produtividade (1 = mais produtivo)
Ranking Produtividade = 
RANKX(
    FILTER(
        ALL(DimInstituicao[InstituicaoNome]),
        [Registros com RH] > 0
    ),
    [Atendimentos por M√©dico],
    ,
    DESC,
    DENSE
)

// Top/Bottom Flags
√â Top 10 N√£o Urgentes = 
[Ranking N√£o Urgentes] <= 10

√â Bottom 10 Eficiente = 
RANKX(
    ALL(DimInstituicao[InstituicaoNome]),
    [% N√£o Urgentes],
    ,
    ASC,
    DENSE
) <= 10


// ============================================================================
// 8Ô∏è‚É£ SCORE DE INEFICI√äNCIA GLOBAL
// ============================================================================

// Score combinado (0-100, quanto maior pior)
Score Inefici√™ncia Global = 
VAR Score_NaoUrgentes = [% N√£o Urgentes] * 40  // Peso 40%
VAR Score_TempoEspera = MIN(DIVIDE([Tempo Espera M√©dio], 120, 0), 1) * 30  // Peso 30%
VAR Score_Produtividade = 
    IF(
        [Registros com RH] > 0,
        (1 - MIN(DIVIDE([Atendimentos por M√©dico], 500, 0), 1)) * 15,  // Peso 15%
        0
    )
VAR Score_Custos = MIN(DIVIDE([Custo Desperdi√ßado com N√£o Urgentes], [Despesa Efetiva], 0), 1) * 15  // Peso 15%
RETURN
    Score_NaoUrgentes + Score_TempoEspera + Score_Produtividade + Score_Custos
    // TOTAL: 0-100 pontos

// Classifica√ß√£o Geral
Classifica√ß√£o Inefici√™ncia = 
VAR Score = [Score Inefici√™ncia Global]
RETURN
SWITCH(
    TRUE(),
    Score < 20, "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excelente",
    Score < 35, "‚≠ê‚≠ê‚≠ê‚≠ê Bom",
    Score < 50, "‚≠ê‚≠ê‚≠ê Satisfat√≥rio",
    Score < 65, "‚≠ê‚≠ê Aten√ß√£o",
    "‚≠ê Cr√≠tico"
)


// ============================================================================
// 9Ô∏è‚É£ MEDIDAS AUXILIARES E FILTROS
// ============================================================================

// Contadores
Total Institui√ß√µes = 
DISTINCTCOUNT(FactAtendimentosUrgencia[InstituicaoID])

Total Regi√µes = 
DISTINCTCOUNT(FactAtendimentosUrgencia[RegiaoID])

Total Meses = 
DISTINCTCOUNT(FactAtendimentosUrgencia[Per√≠odo])

// Filtro Temporal
Primeiro Per√≠odo = 
MIN(DimCalendar[Data])

√öltimo Per√≠odo = 
MAX(DimCalendar[Data])

// Flags √∫teis
Tem Dados Custos = 
IF([Registros com Custos] > 0, TRUE(), FALSE())

Tem Dados RH = 
IF([Registros com RH] > 0, TRUE(), FALSE())

// Para tooltips
Detalhe Institui√ß√£o = 
SELECTEDVALUE(DimInstituicao[InstituicaoNome], "V√°rias Institui√ß√µes")

Tipo Institui√ß√£o = 
SELECTEDVALUE(DimInstituicao[Tipo], "V√°rios Tipos")

Regi√£o = 
SELECTEDVALUE(DimRegiao[RegiaoNome], "V√°rias Regi√µes")


// ============================================================================
// üîü AN√ÅLISE POR SAZONALIDADE (DimCalendar)
// ============================================================================

// Atendimentos por Esta√ß√£o do Ano
Atendimentos Inverno = 
CALCULATE(
    [Total Atendimentos],
    DimCalendar[Sazonalidade] = "Inverno"
)

Atendimentos Primavera = 
CALCULATE(
    [Total Atendimentos],
    DimCalendar[Sazonalidade] = "Primavera"
)

Atendimentos Ver√£o = 
CALCULATE(
    [Total Atendimentos],
    DimCalendar[Sazonalidade] = "Ver√£o"
)

Atendimentos Outono = 
CALCULATE(
    [Total Atendimentos],
    DimCalendar[Sazonalidade] = "Outono"
)

// An√°lise Fim de Semana vs Dias √öteis
Atendimentos Fim Semana = 
CALCULATE(
    [Total Epis√≥dios],  // Da FactMonitorizacaoSazonal (granularidade di√°ria)
    DimCalendar[√â Fim de Semana] = TRUE()
)

Atendimentos Dias √öteis = 
CALCULATE(
    [Total Epis√≥dios],
    DimCalendar[Tipo de Dia] = "Dia √ötil"
)

Atendimentos Feriados = 
CALCULATE(
    [Total Epis√≥dios],
    DimCalendar[√â Feriado] = TRUE()
)

// Compara√ß√£o Fim de Semana
% Aumento Fim Semana = 
VAR MediaFDS = DIVIDE([Atendimentos Fim Semana], 
    CALCULATE(DISTINCTCOUNT(DimCalendar[Data]), DimCalendar[√â Fim de Semana] = TRUE()), 0)
VAR MediaUtil = DIVIDE([Atendimentos Dias √öteis], 
    CALCULATE(DISTINCTCOUNT(DimCalendar[Data]), DimCalendar[Tipo de Dia] = "Dia √ötil"), 0)
RETURN
    DIVIDE(MediaFDS - MediaUtil, MediaUtil, 0)


/ ============================================================================
// Cobertura: Atendimentos, Custos, RH, Tempo Espera, Sazonalidade, Rankings
// ============================================================================

UPDATE


// ============================================================================
// MEDIDAS DE SCORE - VERS√ÉO SEM DADOS REAIS DE CUSTOS
// ============================================================================
// Como n√£o h√° colunas Despesa/NumDoentes, usamos custo estimado fixo de 150‚Ç¨
// ============================================================================


// ============================================================================
// SCORE SIMPLIFICADO (Recomendado - 3 componentes)
// ============================================================================

Score Inefici√™ncia Simplificado = 
VAR Score_NaoUrgentes = [% N√£o Urgentes] * 50  // Peso 50% (0-50 pontos)
VAR Score_TempoEspera = MIN(DIVIDE([Tempo Espera M√©dio], 120, 0), 1) * 35  // Peso 35% (0-35 pontos)
VAR Score_Produtividade = 
    IF(
        [Registros com RH] > 0,
        (1 - MIN(DIVIDE([Atendimentos por M√©dico], 500, 0), 1)) * 15,  // Peso 15% (0-15 pontos)
        0
    )
RETURN
    Score_NaoUrgentes + Score_TempoEspera + Score_Produtividade
    // TOTAL: 0-100 pontos


// ============================================================================
// CLASSIFICA√á√ÉO (Usar com Score Simplificado)
// ============================================================================

Classifica√ß√£o Inefici√™ncia = 
VAR Score = [Score Inefici√™ncia Simplificado]
RETURN
SWITCH(
    TRUE(),
    Score < 20, "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excelente",
    Score < 35, "‚≠ê‚≠ê‚≠ê‚≠ê Bom",
    Score < 50, "‚≠ê‚≠ê‚≠ê Satisfat√≥rio",
    Score < 65, "‚≠ê‚≠ê Aten√ß√£o",
    "‚≠ê Cr√≠tico"
)


// ============================================================================
// AN√ÅLISE DE "SEM TRIAGEM" (para investiga√ß√£o)
// ============================================================================

% Sem Triagem = 
DIVIDE([Atendimentos Sem Triagem], [Total Atendimentos], 0)

// Cen√°rio conservador: N√ÉO inclui Sem Triagem
Atendimentos N√£o Urgentes (Conservador) = 
[Atendimentos Verde] + [Atendimentos Azul] + [Atendimentos Branca]

% N√£o Urgentes (Conservador) = 
DIVIDE([Atendimentos N√£o Urgentes (Conservador)], [Total Atendimentos], 0)

// Cen√°rio pessimista: INCLUI Sem Triagem  
Atendimentos N√£o Urgentes (Pessimista) = 
[Atendimentos Verde] + [Atendimentos Azul] + [Atendimentos Branca] + [Atendimentos Sem Triagem]

% N√£o Urgentes (Pessimista) = 
DIVIDE([Atendimentos N√£o Urgentes (Pessimista)], [Total Atendimentos], 0)

// Alerta se Sem Triagem > 5% (indica problema no processo)
Alerta Sem Triagem = 
IF(
    [% Sem Triagem] > 0.05,
    "‚ö†Ô∏è ATEN√á√ÉO: " & FORMAT([% Sem Triagem], "0.0%") & " sem triagem (investigar)",
    "‚úÖ Normal (" & FORMAT([% Sem Triagem], "0.0%") & ")"
)


// ============================================================================
// AN√ÅLISE DE CUSTOS (com valor fixo 150‚Ç¨)
// ============================================================================

// Custo total baseado em epis√≥dios
Despesa Total Estimada = 
[Total Atendimentos] * [Custo Estimado por Epis√≥dio]

// Custo desperdi√ßado com atendimentos n√£o urgentes
Custo Desperdi√ßado com N√£o Urgentes = 
VAR AtendimentosNaoUrgentes = [Atendimentos N√£o Urgentes]
VAR CustoUrgencia = 150  // Urg√™ncia hospitalar
VAR CustoCentroSaude = 30  // Centro de Sa√∫de (estimativa)
VAR DiferencaCusto = CustoUrgencia - CustoCentroSaude
RETURN
    AtendimentosNaoUrgentes * DiferencaCusto
    // = N√∫mero de casos n√£o urgentes √ó 120‚Ç¨ desperdi√ßados por caso


// Custo desperdi√ßado anualizado (para proje√ß√µes)
Custo Desperdi√ßado Anual = 
VAR MesesComDados = DISTINCTCOUNT(FactAtendimentosUrgencia[Per√≠odo])
VAR CustoTotal = [Custo Desperdi√ßado com N√£o Urgentes]
RETURN
    IF(
        MesesComDados > 0,
        (CustoTotal / MesesComDados) * 12,
        0
    )


// ============================================================================
// MEDIDAS AUXILIARES DE CONTAGEM (se n√£o existirem)
// ============================================================================

Total Meses = 
DISTINCTCOUNT(FactAtendimentosUrgencia[Per√≠odo])

Total Meses no Filtro = 
COUNTROWS(
    SUMMARIZE(
        FactAtendimentosUrgencia,
        FactAtendimentosUrgencia[Per√≠odo]
    )
)


// ============================================================================
// MEDIDAS DE DEBUG (para verificar c√°lculos)
// ============================================================================

Debug Score Componentes = 
"N√£o Urgentes: " & FORMAT([% N√£o Urgentes] * 50, "0.00") & " pts" &
" | Tempo Espera: " & FORMAT(MIN(DIVIDE([Tempo Espera M√©dio], 120, 0), 1) * 35, "0.00") & " pts" &
" | Produtividade: " & FORMAT(
    IF([Registros com RH] > 0, (1 - MIN(DIVIDE([Atendimentos por M√©dico], 500, 0), 1)) * 15, 0), "0.00"
) & " pts" &
" | TOTAL: " & FORMAT([Score Inefici√™ncia Simplificado], "0.00") & " pts"


Debug % Componentes Score = 
VAR Total = [Score Inefici√™ncia Simplificado]
VAR Comp1 = [% N√£o Urgentes] * 50
VAR Comp2 = MIN(DIVIDE([Tempo Espera M√©dio], 120, 0), 1) * 35
VAR Comp3 = IF([Registros com RH] > 0, (1 - MIN(DIVIDE([Atendimentos por M√©dico], 500, 0), 1)) * 15, 0)
RETURN
    IF(
        Total > 0,
        "N√£o Urgentes: " & FORMAT(DIVIDE(Comp1, Total, 0), "0%") &
        " | Espera: " & FORMAT(DIVIDE(Comp2, Total, 0), "0%") &
        " | Produtividade: " & FORMAT(DIVIDE(Comp3, Total, 0), "0%"),
        "N/A"
    )


// ============================================================================
// MEDIDAS AUXILIARES (se ainda n√£o existem)
// ============================================================================

// Verifica se h√° dados de RH
Registros com RH = 
CALCULATE(
    COUNTROWS(FactAtendimentosUrgencia),
    FactAtendimentosUrgencia[M√©dicos] > 0
)

Tem Dados RH = 
IF([Registros com RH] > 0, "‚úÖ Sim", "‚ùå N√£o")


// ============================================================================
// REMO√á√ÉO: Medidas antigas que dependiam de Despesa/NumDoentes
// ============================================================================

// ‚ùå REMOVER do ficheiro original:
// - Registros com Custos
// - % Desvio Custo  
// - Ranking Custo
// - Score Inefici√™ncia Global (vers√£o com 4 componentes)

// ‚úÖ MANTER no ficheiro original:
// - Custo Estimado por Epis√≥dio = 150
// - Despesa Total Estimada
// - Custo M√©dio por Doente (se houver)
// - Custo por Atendimento (se houver)


// ============================================================================
// EXEMPLO DE USO
// ============================================================================

/*
CART√ÉO 1: Score Inefici√™ncia Simplificado
Resultado esperado: 0-100 (ex: 42.5)

CART√ÉO 2: Classifica√ß√£o Inefici√™ncia  
Resultado esperado: "‚≠ê‚≠ê‚≠ê Satisfat√≥rio"

CART√ÉO 3: Debug Score Componentes
Resultado esperado: "N√£o Urgentes: 17.50 pts | Tempo Espera: 15.75 pts | Produtividade: 9.25 pts | TOTAL: 42.50 pts"

CART√ÉO 4: Custo Desperdi√ßado com N√£o Urgentes
Resultado esperado: 2.400.000 (em euros)
*/

// ============================================================================
// üÜï MELHORIAS E VALIDA√á√ïES (Dezembro 2025)
// ============================================================================

// VALIDA√á√ÉO: Verificar integridade dos dados
Valida√ß√£o Total Atendimentos = 
VAR SomaCores = 
    [Atendimentos Vermelha] + [Atendimentos Laranja] + [Atendimentos Amarela] +
    [Atendimentos Verde] + [Atendimentos Azul] + [Atendimentos Branca] + 
    [Atendimentos Sem Triagem]
VAR Diferenca = ABS([Total Atendimentos] - SomaCores)
RETURN Diferenca

// MELHORIA: Total sem casos n√£o triados (mais preciso)
Total Atendimentos Triados = 
[Total Atendimentos] - [Atendimentos Sem Triagem]

// MELHORIA: % N√£o Urgentes ajustado (excluindo sem triagem)
% N√£o Urgentes (Ajustado) = 
DIVIDE([Atendimentos N√£o Urgentes], [Total Atendimentos Triados], 0)

// MELHORIA: Total de M√©dicos v√°lidos (>0)
Total M√©dicos V√°lidos = 
CALCULATE(
    SUM(FactAtendimentosUrgencia[M√©dicos]),
    FactAtendimentosUrgencia[M√©dicos] > 0
)

// MELHORIA: Contagem de registros com RH v√°lido
Registros com RH V√°lido = 
CALCULATE(
    COUNTROWS(FactAtendimentosUrgencia),
    FactAtendimentosUrgencia[M√©dicos] > 0,
    FactAtendimentosUrgencia[Enfermeiros] > 0
)

// QUALIDADE: Taxa de cobertura de dados RH
Taxa Cobertura RH = 
DIVIDE(
    [Registros com RH V√°lido],
    COUNTROWS(FactAtendimentosUrgencia),
    0
)

// MELHORIA: Atendimentos por M√©dico (apenas registros v√°lidos)
Atendimentos por M√©dico (V√°lido) = 
VAR AtendimentosComRH = 
    CALCULATE(
        [Total Atendimentos],
        FactAtendimentosUrgencia[M√©dicos] > 0
    )
VAR MedicosValidos = [Total M√©dicos V√°lidos]
RETURN
    DIVIDE(AtendimentosComRH, MedicosValidos, 0)

// AN√ÅLISE: Institui√ß√µes sem dados RH
Institui√ß√µes Sem RH = 
CALCULATE(
    DISTINCTCOUNT(FactAtendimentosUrgencia[InstituicaoID]),
    FactAtendimentosUrgencia[M√©dicos] = 0,
    FactAtendimentosUrgencia[Enfermeiros] = 0
)

// AN√ÅLISE: Total de registros
Total Registros = 
COUNTROWS(FactAtendimentosUrgencia)

// BENCHMARK: Compara√ß√£o com m√©dia nacional
Desvio da M√©dia Nacional (N√£o Urgentes) = 
VAR MediaNacional = 
    CALCULATE(
        [% N√£o Urgentes],
        ALL(DimInstituicao)
    )
VAR ValorAtual = [% N√£o Urgentes]
RETURN
    ValorAtual - MediaNacional

// BENCHMARK: Status comparativo
Status vs M√©dia Nacional = 
VAR Desvio = [Desvio da M√©dia Nacional (N√£o Urgentes)]
RETURN
    SWITCH(
        TRUE(),
        Desvio < -0.10, "üü¢ Muito Abaixo (-10pp)",
        Desvio < 0, "üü° Abaixo da M√©dia",
        Desvio < 0.10, "üü† Acima da M√©dia",
        "üî¥ Muito Acima (+10pp)"
    )

// ============================================================================
// FIM DO FICHEIRO
// ============================================================================

